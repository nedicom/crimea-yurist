<div id="modalOverlay"
    style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9998; display: none;">
</div>

<div id="consultationModal"
    style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2.5rem; border-radius: 1rem; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); z-index: 9999; border: 1px solid #e5e7eb; min-width: 320px;">
    <div style="text-align: center;">

        <!-- Крестик закрытия -->
        <button id="closeModal"
            style="position: absolute; top: 1rem; right: 1rem; background: none; border: none; cursor: pointer; color: #6b7280; font-size: 2.5rem;">
            ×
        </button>

        <!-- Иконка телефона -->
        <div
            style="width: 64px; height: 64px; background: #3b82f6; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem;">
            <svg style="width: 32px; height: 32px; color: white;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
            </svg>
        </div>

        <!-- Заголовок -->
        <h3 style="font-size: 1.5rem; font-weight: bold; color: #1f2937; margin-bottom: 1rem;">Консультация юриста</h3>

        <!-- Описание -->
        <p style="color: #6b7280; margin-bottom: 1.5rem; line-height: 1.5;">Получите профессиональную юридическую
            консультацию по телефону</p>

        <!-- Телефон -->
        <div style="background: #f8fafc; padding: 1rem; border-radius: 0.75rem; margin-bottom: 1.5rem;">
            <a href="tel:{{ page.phone|default:'+79789104297'|cut:' '|cut:'-'|cut:'('|cut:')' }}"
                style="text-decoration: none;">
                <p style="font-size: 2.25rem; color: #2563eb; font-weight: bold; margin: 0; transition: color 0.2s;">
                    {{ page.phone|default:'+7 978 910-42-97' }}
                </p>
            </a>
        </div>

        <!-- Дополнительная информация -->
        <p style="color: #9ca3af; font-size: 0.875rem; margin-top: 1.5rem;">Работаем ежедневно с 9:00 до 21:00</p>
    </div>
</div>

<!-- Скрипт модального окна и тестов -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const modal = document.getElementById('consultationModal');
  const modalOverlay = document.getElementById('modalOverlay');
  const closeModal = document.getElementById('closeModal');
  
  // Скрываем модальное окно при загрузке
  modal.style.display = 'none';
  modalOverlay.style.display = 'none';
  
  // Функции для работы с куки
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }
  
  function setCookie(name, value, days = 30) {
    const date = new Date();
    date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
    document.cookie = `${name}=${value}; expires=${date.toUTCString()}; path=/`;
  }
  
  // Функция для отправки целей в Яндекс.Метрику
  function sendYandexMetricaGoal(goalName) {
    // Проверяем куки, не отправляли ли уже эту цель
    const sentGoalsCookie = getCookie('yandex_goals');
    const sentGoals = sentGoalsCookie ? JSON.parse(sentGoalsCookie) : {};
    
    if (sentGoals[goalName]) {
      console.log(`Цель "${goalName}" уже была отправлена ранее`);
      return; // Уже отправляли - выходим
    }
    
    // Отправляем только если Метрика уже загрузилась
    if (typeof ym !== 'undefined') {
      ym(104280599, 'reachGoal', goalName);
      console.log(`Цель "${goalName}" отправлена в Яндекс.Метрику`);
      
      // Сохраняем в куки, что цель отправлена
      sentGoals[goalName] = true;
      setCookie('yandex_goals', JSON.stringify(sentGoals), 30);
    } else {
      console.log(`Цель "${goalName}" не отправлена - Яндекс.Метрика не загружена`);
    }
  }
  
  // Функция для открытия модального окна
  function openModal() {
    modal.style.display = 'block';
    modalOverlay.style.display = 'block';
    console.log('Модальное окно открыто');
    
    // Яндекс.Метрика - цель "Открытие модального окна консультации"
    sendYandexMetricaGoal('consultation_modal_open');
  }
  
  // Функция для закрытия модального окна
  function closeModalFunc() {
    modal.style.display = 'none';
    modalOverlay.style.display = 'none';
    console.log('Модальное окно закрыто');
  }
  
  // Добавляем обработчики для кнопок с классом consultation-btn
  document.querySelectorAll('.consultation-btn').forEach(button => {
    button.addEventListener('click', openModal);
  });
  
  // Закрытие по крестику
  if (closeModal) {
    closeModal.addEventListener('click', closeModalFunc);
  }
  
  // Закрытие по клику на оверлей
  modalOverlay.addEventListener('click', closeModalFunc);
  
  // Закрытие по ESC
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && modal.style.display === 'block') {
      closeModalFunc();
    }
  });
  
  // Отслеживание кликов по номеру телефона в модальном окне
  const phoneLinks = modal.querySelectorAll('a[href^="tel:"]');
  phoneLinks.forEach(link => {
    link.addEventListener('click', function() {
      console.log('Клик по номеру телефона');
      // Яндекс.Метрика - цель "Клик по телефону в модальном окне"
      sendYandexMetricaGoal('consultation_modal_phone_click');
    });
  });

  // ===== ТЕСТЫ =====
  function runTests() {
    console.log('=== ЗАПУСК ТЕСТОВ ===');
    
    // Тест 1: Проверка начального состояния
    console.log('Тест 1 - Модальное окно скрыто при загрузке:', modal.style.display === 'none' ? '✅ ПРОЙДЕН' : '❌ НЕ ПРОЙДЕН');
    
    // Тест 2: Проверка открытия модального окна
    openModal();
    console.log('Тест 2 - Модальное окно открывается:', modal.style.display === 'block' ? '✅ ПРОЙДЕН' : '❌ НЕ ПРОЙДЕН');
    
    // Тест 3: Проверка закрытия модального окна
    closeModalFunc();
    console.log('Тест 3 - Модальное окно закрывается:', modal.style.display === 'none' ? '✅ ПРОЙДЕН' : '❌ НЕ ПРОЙДЕН');
    
    // Тест 4: Проверка работы с куки
    setCookie('test_cookie', 'test_value', 1);
    const cookieValue = getCookie('test_cookie');
    
    // Тест 5: Проверка кнопок
    const buttons = document.querySelectorAll('.consultation-btn');
    console.log('Тест 5 - Кнопки найдены:', buttons.length > 0 ? `✅ ПРОЙДЕН (${buttons.length} кнопок)` : '❌ НЕ ПРОЙДЕН');
    
    // Тест 6: Проверка Яндекс.Метрики
    console.log('Тест 6 - Яндекс.Метрика доступна:', typeof ym !== 'undefined' ? '✅ ПРОЙДЕН' : '⚠️ НЕ ДОСТУПНА (ждем загрузки)');
    
    // Тест 7: Проверка дублирования целей
    console.log('Тест 7 - Проверка дублирования целей:');
    sendYandexMetricaGoal('test_goal');
    sendYandexMetricaGoal('test_goal'); // Должен проигнорироваться
    
    console.log('=== ТЕСТЫ ЗАВЕРШЕНЫ ===\n');
    
    // Очистка тестового куки
    document.cookie = "test_cookie=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
  }

  // Запускаем тесты через 1 секунду после загрузки
  setTimeout(runTests, 1000);
  
  // Инструкция для ручного тестирования
  console.log('=== РУЧНОЕ ТЕСТИРОВАНИЕ ===');
  console.log('1. Нажмите кнопку "На консультацию" - должно открыться модальное окно');
  console.log('2. Нажмите на номер телефона в модальном окне - должна отправиться цель');
  console.log('3. Закройте модальное окно (крестик, ESC или клик вне окна)');
  console.log('4. Повторно откройте модальное окно - цели не должны дублироваться');
  console.log('5. Проверьте куки в DevTools → Application → Cookies → yandex_goals');
});
</script>